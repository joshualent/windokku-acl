#!/usr/bin/env bash
# When enabled via the DOKKU_ACL_USER_COMMANDS variable, allow normal users
# to run only these commands.

set -eo pipefail
[[ $DOKKU_TRACE ]] && set -x

source "$PLUGIN_CORE_AVAILABLE_PATH/common/functions"
source "$(dirname "${BASH_SOURCE[0]}")/internal-functions"

DOKKU_SUPER_USER="${DOKKU_SUPER_USER:-}"
DOKKU_ACL_USER_COMMANDS="${DOKKU_ACL_USER_COMMANDS:-}"
DOKKU_ACL_PER_APP_COMMANDS="${DOKKU_ACL_PER_APP_COMMANDS:-}"
DOKKU_ACL_PER_SERVICE_COMMANDS="${DOKKU_ACL_PER_SERVICE_COMMANDS:-}"
DOKKU_ACL_LINK_COMMANDS="${DOKKU_ACL_LINK_COMMANDS:-}"

SSH_USER=$1
SSH_NAME=$2
shift 2

[[ -z "$DOKKU_ACL_USER_COMMANDS" && -z "$DOKKU_ACL_PER_APP_COMMANDS" && -z "$DOKKU_ACL_PER_SERVICE_COMMANDS" && -z "$DOKKU_ACL_LINK_COMMANDS" ]] && exit 0
[[ "$SSH_USER" == "root" ]] && exit 0
[[ -n "$DOKKU_SUPER_USER" ]] && [[ "$SSH_NAME" == "$DOKKU_SUPER_USER" ]] && exit 0

CMD=$1

# Allow acl:apps so users can list their own apps without requiring admin configuration
if [[ "$CMD" == "$PLUGIN_COMMAND_PREFIX:apps" ]]; then
  exit 0
fi

# Capture creator identity for app/service creation so post-create hooks can attribute ownership
# Harmless if the command later fails; post-create hooks will clean up any marker files.
RUN_BASE="/var/run/dokku-acl-auto"
case "$CMD" in
  apps:create)
    if [[ -n "$2" && -n "$SSH_NAME" ]]; then
      mkdir -p "$RUN_BASE/apps"
      printf "%s" "$SSH_NAME" > "$RUN_BASE/apps/$2" || true
    fi
    ;;
  *:create)
    # Matches service creation like redis:create mystore
    if [[ -n "$2" && -n "$SSH_NAME" ]]; then
      svc_type="${CMD%%:*}"
      mkdir -p "$RUN_BASE/services/$svc_type"
      printf "%s" "$SSH_NAME" > "$RUN_BASE/services/$svc_type/$2" || true
    fi
    ;;
esac

for allowed in $DOKKU_ACL_USER_COMMANDS; do
  [[ "$CMD" == "$allowed" ]] && exit 0
done

for allowed in $DOKKU_ACL_PER_APP_COMMANDS; do
  if [[ "$CMD" == "$allowed" ]]; then
    if [[ -z "$2" ]]; then
      dokku_log_fail "An app name is required"
    fi
    # shellcheck disable=SC1003
    APP_NAME="$(echo "$2" | perl -pe 's/(?<!\\)'\''//g' | sed 's/\\'\''/'\''/g' | sed 's/^\///g')"
    fn-check-app-acl "$APP_NAME" "$SSH_NAME" && exit 0
  fi
done

for allowed in $DOKKU_ACL_PER_SERVICE_COMMANDS; do
  if [[ "$CMD" == "$allowed" ]]; then
    if [[ -z "$2" ]]; then
      dokku_log_fail "A service name is required"
    fi

    fn-check-service-acl "$CMD" "$2" "$SSH_NAME" && exit 0
  fi
done

for allowed in $DOKKU_ACL_LINK_COMMANDS; do
  if [[ "$CMD" == "$allowed" ]]; then
    if [[ -z "$2" ]]; then
      dokku_log_fail "A service name is required"
    fi

    if [[ -z "$3" ]]; then
      dokku_log_fail "An app name is required"
    fi

    (fn-check-service-acl "$CMD" "$2" "$SSH_NAME") && (fn-check-app-acl "$3" "$SSH_NAME") && exit 0

    # An appropriate failure message has already been sent by the check- function
    exit 1
  fi
done

dokku_log_fail "User $SSH_NAME does not have permissions to run $CMD"
